<div class="note-header">
  <h1 class="note-title page-title">
    <%- partial('_partial/icon', {name: 'folder', size: 22}) %>
    <% if (page.category) { %>
      <%= page.category %>
      <span class="page-title-count"><%= page.posts.length %> notes</span>
    <% } else { %>
      Categories
    <% } %>
  </h1>
</div>

<% if (page.category) { %>
  <!-- Single category view: list posts -->
  <div class="post-list">
    <% page.posts.each(function(post) { %>
    <%- partial('_partial/post-item', { post: post }) %>
    <% }) %>
  </div>
  <%- partial('_partial/pagination') %>

<% } else { %>
  <%
    var allCats = site.categories.toArray();

    // Leaf nodes only
    var leafCats = allCats.filter(function(cat) {
      return !allCats.some(function(other) {
        return other.parent && String(other.parent) === String(cat._id);
      });
    });

    // Build ancestor breadcrumb array for a category
    function getCatAncestors(cat) {
      var parts = [];
      var current = cat;
      for (var i = 0; i < 10; i++) {
        if (!current.parent) break;
        var found = allCats.filter(function(c) {
          return String(c._id) === String(current.parent);
        })[0];
        if (!found) break;
        parts.unshift({ name: found.name, path: found.path });
        current = found;
      }
      return parts;
    }

    leafCats.sort(function(a, b) {
      var aPath = getCatAncestors(a).map(function(x) { return x.name; }).concat(a.name).join('/');
      var bPath = getCatAncestors(b).map(function(x) { return x.name; }).concat(b.name).join('/');
      return aPath.localeCompare(bPath);
    });
  %>

  <div class="categories-grid">
    <% leafCats.forEach(function(cat) { %>
    <%
      var ancestors = getCatAncestors(cat);
      var isDeep = ancestors.length > 0;
    %>
    <a href="<%- url_for(cat.path) %>" class="category-card<%= isDeep ? ' category-card-deep' : '' %>">

      <% if (isDeep) { %>
      <!-- Breadcrumb trail -->
      <div class="category-card-breadcrumb">
        <% ancestors.forEach(function(anc, i) { %>
        <span class="breadcrumb-part"><%= anc.name %></span>
        <%- partial('_partial/icon', {name: 'chevron-right', size: 10, cls: 'breadcrumb-sep', sw: 2.5}) %>
        <% }) %>
      </div>
      <% } %>

      <div class="category-card-body">
        <div class="category-card-icon">
          <%- partial('_partial/icon', {name: 'file-text', size: 26, sw: 1.5}) %>
        </div>
        <div class="category-card-info">
          <span class="category-card-name"><%= cat.name %></span>
          <span class="category-card-count"><%= cat.posts.length %> <%= cat.posts.length === 1 ? 'note' : 'notes' %></span>
        </div>
      </div>

    </a>
    <% }) %>
  </div>
<% } %>
